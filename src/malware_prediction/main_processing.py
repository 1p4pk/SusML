import os
import socket
import time
import sys

from preprocessor import Preprocessor

MESSAGE = """
            --- {hostname} ---
                             
                {row_num}     
                             
            --- {run_time} S ---"""

TRAIN_CSV_PATH = "./data/train/train.csv"
TRAIN_ENCODED_CSV_PATH = "./data/train/train_encoded_{rank}.csv"


def run(row_num):
    world_size = int(os.environ['OMPI_COMM_WORLD_SIZE'])
    world_rank = int(os.environ['OMPI_COMM_WORLD_RANK'])
    hostname = socket.gethostname()
    print(f"Running rank {world_rank} of {world_size} on {hostname}")
    df = Preprocessor().import_data(TRAIN_CSV_PATH, row_num, offset=row_num * world_rank + 1)
    Preprocessor().encode_data(df)
    df.to_csv(TRAIN_ENCODED_CSV_PATH.format(rank=world_rank), index=False)


def benchmark(fn=run):
    row_num = int(sys.argv[1])
    hostname = socket.gethostname()
    start_time = time.time()
    fn(row_num)
    run_time = round(time.time() - start_time, 2)
    with open(f"./data/benchmark/run_time_preprocessing_{row_num}.csv", "a") as eval_file:
        eval_file.writelines(f"{hostname},{row_num},{run_time}\n")
    print(MESSAGE.format(hostname=hostname, row_num=row_num, run_time=run_time))


if __name__ == '__main__':
    benchmark(run)

