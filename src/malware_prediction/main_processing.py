import os
import socket
import sys

from benchmark import timeit
from preprocessor import Preprocessor

SIZE = int(os.environ['OMPI_COMM_WORLD_SIZE'])
RANK = int(os.environ['OMPI_COMM_WORLD_RANK'])
HOSTNAME = socket.gethostname()

TEST_CSV_PATH = "./data/test/test.csv"
TRAIN_CSV_PATH = "./data/train/train.csv"

# TRAIN_ENCODED_CSV_PATH = f"./data/train/train_encoded.csv"
# TEST_ENCODED_CSV_PATH = f"./data/test/test_encoded.csv"

TRAIN_ENCODED_CSV_PATH = f"./data/train/train_encoded_{RANK}.csv"
TEST_ENCODED_CSV_PATH = f"./data/test/test_encoded_{RANK}.csv"

preprocessor = Preprocessor()
ROWS = row_num_train = int(sys.argv[1])


@timeit(save_path=f"./data/benchmark/run_time_preprocessing_{ROWS}.csv", row_count=ROWS)
def run():
    print(f"Running train preprocessing with rank {RANK} of {SIZE} on {HOSTNAME}")
    df = preprocessor.import_data(TRAIN_CSV_PATH, ROWS, offset=ROWS * RANK + 1)
    preprocessor.encode_data(df)
    df.to_csv(TRAIN_ENCODED_CSV_PATH, index=False)


def run_test_encoding():
    print(f"Running test preprocessing with rank {RANK} of {SIZE} on {HOSTNAME}")
    row_num_test = int(sys.argv[2])
    df = preprocessor.import_data(TEST_CSV_PATH, row_num_test, offset=row_num_test * RANK + 1, is_train=False)
    preprocessor.encode_data(df, is_train=False)
    df.to_csv(TEST_ENCODED_CSV_PATH, index=False)


if __name__ == '__main__':
    run()
    run_test_encoding()
