import os
import socket
import time

import pandas as pd
import torch
from dataset import MalwareDataset
from model import MalwarePredictor
from torch import distributed as dist
from torch import nn
from torch import optim
from torch.nn.parallel import DistributedDataParallel as DDP
from torch.utils.data.dataloader import DataLoader
from train import ModelTrainer

SIZE = int(os.environ['OMPI_COMM_WORLD_SIZE'])
RANK = int(os.environ['OMPI_COMM_WORLD_RANK'])
HOSTNAME = socket.gethostname()

TRAIN_ENCODED_CSV_PATH = f"./data/train/train_encoded_{RANK}.csv"
TEST_ENCODED_CSV_PATH = f"./data/test/test_encoded_{RANK}.csv"
ROWS = 0
MESSAGE = """
            --- {hostname} ---
                                                          
            --- {run_time} S ---"""


def run(backend='mpi'):
    print("Start run model:")
    dist.init_process_group(backend)
    print("Data prepared.")
    dataset = MalwareDataset.load(TRAIN_ENCODED_CSV_PATH)
    loader = DataLoader(dataset, batch_size=100)
    global ROWS
    ROWS = loader.dataset.rows
    print(f"Number of rows: {ROWS}")
    print("Length columns: " + str(len(loader.dataset.cols)))
    model = DDP(MalwarePredictor(len(loader.dataset.cols), 100, 100, 1))
    loss = nn.MSELoss()
    optimizer = optim.SGD(model.parameters(), lr=0.01)
    print("Model prepared.")
    print("Process group initialized.")
    trainer = ModelTrainer(loader, model, loss, optimizer)
    print("Trainer initialized.")
    trainer.train(20, verbose=True)
    print("Done training.")
    dist.destroy_process_group()

    dataset = MalwareDataset.load(TEST_ENCODED_CSV_PATH, is_train=False)
    loader = DataLoader(dataset, batch_size=100)
    run_eval(model, loader)


def run_eval(model, data_loader: DataLoader):
    model.eval()
    predictions = []

    X_test = data_loader.dataset.X

    print(data_loader.dataset.cols)

    id = data_loader.dataset.y

    with torch.no_grad():
        for val in X_test:
            y_hat = model.forward(val)
            predictions.append(y_hat.argmax().item())

    for prediction in predictions:
        print(prediction)

    df = pd.DataFrame({'MachineIdentifier': id, 'YHat': predictions})
    df.to_csv(f"./data/train/submission_{RANK}.csv")


def init_processes(fn):
    """ Initialize the distributed environment. """
    world_size = int(os.environ['OMPI_COMM_WORLD_SIZE'])
    world_rank = int(os.environ['OMPI_COMM_WORLD_RANK'])
    hostname = socket.gethostname()
    print(f"Running rank {world_rank} of {world_size} on {hostname}")
    fn()


def benchmark(fn=run):
    hostname = socket.gethostname()
    start_time = time.time()
    init_processes(fn)
    run_time = round(time.time() - start_time, 2)
    with open(f"./data/benchmark/run_time_model_{ROWS}.csv", "a") as eval_file:
        eval_file.writelines(f"{hostname},{ROWS},{run_time}\n")
    print(MESSAGE.format(hostname=hostname, run_time=run_time))


if __name__ == '__main__':
    benchmark(run)
